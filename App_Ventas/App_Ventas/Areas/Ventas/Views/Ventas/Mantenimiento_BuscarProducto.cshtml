@model App_Ventas.Areas.Ventas.Models.ProductoModelView
<script src="@Url.Content("~/Scripts/Js/Recursiva/BuscarProcutos.js")" type="text/javascript"></script>
<script>
    var _Valido = false;
    var _Grilla = $('#hdf_Grilla').val();
    $(document).ready(function () {
        ConfigurarFormulario();
        $('#CANTIDAD').numeric();
        setTimeout(function () { $('#SEARCH_PRODUCTO').focus(); }, 500)
    });
    // al cerrar el modal hijo el padre sigue con la clase modal open. 
    $(document).on('hidden.bs.modal', '.modal', function () {
        $('.modal:visible').length && $(document.body).addClass('modal-open');
    });

    $('#Sucursal_Btn_Guardar').click(function () {
        if (_Valido) {
            if ($('#frmMantenimiento_BuscarProducto').valid()) {
                var rowKey = jQuery("#" + _Grilla).getDataIDs();
                var ix = rowKey.length;
                ix++;
                var myData =
                      {
                          CODIGO: ix,
                          ID_PRODUCTO: $("#hfd_ID_PRODUCTO").val(),
                          PRODUCTO: $("#SEARCH_PRODUCTO").val(),
                          PRECIO: Number($("#PRECIO_VENTA").val()).toFixed(2),
                          CANTIDAD: $("#CANTIDAD").val(),
                          IMPORTE: Number($("#TOTAL").val()).toFixed(2)
                      };

                if (Ventas_Detalle_BuscarProducto_Grilla($('#hfd_ID_PRODUCTO').val())) {
                    jError('Producto seleccionado ya se encuentra en la lista.', 'Atención');
                } else {
                    jQuery("#" + _Grilla).jqGrid('addRowData', ix, myData);
                    CalcularMontoTotalDetalle();
                }
                LimpiarFormulario();
                $('#_DetallePorductos').hide('');
                $('#SEARCH_PRODUCTO').val('');
                $('#SEARCH_PRODUCTO').focus();
            }
        } else {
            jError('Debe buscar un producto para ingresar a la lista. No seas imbecil', 'Atención');
        }

    });


    $('#Btn_CerrarModal').click(function () {
        $('#myModalBuscarProduc').modal('hide');
    });
    $(function () {
        $(".modal-content").draggable();
    });

    $('#CANTIDAD').keyup(function () {
        var _valor = $(this).val();
        if (_valor == "") {
            _valor = 1
        }
        var _precio = $('#PRECIO_VENTA').val();
        var _stock = parseInt($('#hfd_STOCK').val());
        var _total = 0.0;
        if (_valor < _stock) {
            _total = (_valor * _precio);
            $('#TOTAL').val(Number(_total).toFixed(2));
        } else {
            jError('La cantidad no puede ser mayor al stock.', 'Atención');
            _total = (1 * _precio);
            $('#CANTIDAD').val(1)
            $('#TOTAL').val(Number(_total).toFixed(2));
        }
    });

    function LimpiarFormulario() {
        $('#Alert_Error').hide();
        $('#mensaje_Error').text('');
        $('#hfd_ID_PRODUCTO').val('');
        $('#hfd_STOCK').val('');
        _Valido = false;
    }



    /*autocomplete*/
    $('#SEARCH_PRODUCTO').autocomplete(
    {
        source: function (request, response) {
            $.getJSON('@Url.Action("Producto_Buscar_Listar", "Ventas", new { area = "Ventas" })', { DESC_PRODUCTO: request.term.toUpperCase(), COD_PRODUCTO: '' },
        response);
        },
        minLength: 4,
        select: function (event, ui) {
            LimpiarFormulario();
            if (parseInt(ui.item.STOCK) > 0 && ui.item.FLG_SERVICIO == 0) {
                $('#_DetallePorductos').show('slow');
                $("#SEARCH_PRODUCTO").val(ui.item.DESC_PRODUCTO);
                $("#ID_UNIDAD_MEDIDA").val(ui.item.ID_UNIDAD_MEDIDA);
                $("#COD_PRODUCTO").val(ui.item.COD_PRODUCTO);
                $("#INPUT_STOCK").text(ui.item.STOCK);
                $("#PRECIO_VENTA").val(Number(ui.item.PRECIO_VENTA).toFixed(2));
                $("#DETALLE").val(ui.item.DETALLE);
                $("#hfd_STOCK").val(ui.item.STOCK);
                $('#TOTAL').val(Number(ui.item.PRECIO_VENTA).toFixed(2));
                $('#hfd_ID_PRODUCTO').val(ui.item.ID_PRODUCTO);
                $('#CANTIDAD').val(1);
                _Valido = true;
            } else if (ui.item.FLG_SERVICIO == 1) {
                $('#_DetallePorductos').show('slow');
                $("#SEARCH_PRODUCTO").val(ui.item.DESC_PRODUCTO);
                $("#ID_UNIDAD_MEDIDA").val(ui.item.ID_UNIDAD_MEDIDA);
                $("#COD_PRODUCTO").val(ui.item.COD_PRODUCTO);
                $("#INPUT_STOCK").text(ui.item.STOCK);
                $("#PRECIO_VENTA").val(Number(ui.item.PRECIO_VENTA).toFixed(2));
                $("#DETALLE").val(ui.item.DETALLE);
                $("#hfd_STOCK").val(ui.item.STOCK);
                $('#TOTAL').val(Number(ui.item.PRECIO_VENTA).toFixed(2));
                $('#hfd_ID_PRODUCTO').val(ui.item.ID_PRODUCTO);
                $('#CANTIDAD').val(1);
                _Valido = true;
            }
            else {
                $('#Alert_Error').show('slow');
                $('#mensaje_Error').text('Producto selecionado sin stock ):.');
                _Valido = false;
            }
            return false;
        },
        response: function (event, ui) {
            $("#SEARCH_PRODUCTO").val('');
            return false;
        }
    })
    .data("autocomplete")._renderItem = function (ul, item) {
        debugger;
        var tipo = item.FLG_SERVICIO == 1 ? 'servicio' : 'producto';
        return $("<li id='autocom'></li>")
        .data("item.autocomplete", item)
        .append($("<a></a>").html("<div class='_cListProductos   border-bottom-head'>"
            + "<div class='_text_producto'>" + item.DESC_PRODUCTO + "</div>"
            + "<div class='_InfoProd'> "
            + "<div class='_Stock'> <span> <i class='bi bi-box-seam'></i> stock: </span>" + item.STOCK + "</div>"
            + "<div class='_Precio'> <span> <i class='bi bi-cash-stack'></i> precio: </span>" + item.PRECIO_VENTA + "</div>"
            + "<div class='_Tipo'> <span> <i class='bi bi-cash-stack'></i> tipo: </span>" + tipo + "</div>"
            + "<div class='_FotoPro' style=\" background-image: url(@Url.Content("~/Recursos/ImagenProducto/")" + item.MiArchivo.CODIGO_ARCHIVO + item.MiArchivo.EXTENSION + ") \">  </div>"
            + " </div></div>"

            )).appendTo(ul);
    }

</script>
<style>
    #modal-dialog_this {
        margin: 80px auto;
        float: right;
        margin-right: 5%;
    }

    #modal-header_this {
        background: #2c7be5 !important;
        padding: 8px;
    }

    ._cListProductos {
        padding: 0px 5px 0px 5px;
        max-width: 100%;
    }

    ._text_producto {
        text-align: center;
        color: #2c7be5;
        margin-bottom: 1px;
        font-weight: bold;
    }

    ._InfoProd {
        max-width: 100%;
        height: 50px;
        line-height: 50px;
        text-align: center;
        font-size: 12px;
        /*color:#BDBDC7;*/
    }

    ._Stock, ._Precio, ._Tipo {
        float: left;
        width: 25%;
    }

    ._FotoPro {
        float: right;
        width: 20%;
        /*background-image: url('Recursos/ImagenProducto/c1a1b2fd-ccf8-40d9-be8b-e48a386beffc.png');*/
        background-size: contain;
        background-repeat: no-repeat;
        height: 50px;
    }
</style>

<div class="modal-dialog" role="document" id="modal-dialog_this">
    <div class="modal-content">
        <div class="modal-header" id="modal-header_this">
            <h5 class="modal-title"><i class="bi bi-search"></i>&nbsp; Buscar producto</h5>
        </div>
        <div class="modal-body">
            @using (Html.BeginForm("", "", new { @area = "" }, FormMethod.Post, new { @id = "frmMantenimiento_BuscarProducto" }))
            {
                @Html.ValidationSummary(true)
                <div class="form-row">
                    <p style="font-weight: bold; color: black;"><i class="bi bi-cart-plus"></i>&nbsp; Busca productos o servicios para agregar a la lista de productos. </p>
                    <div class="form-group col-md-12 border-bottom-head">
                        @Html.LabelFor(model => model.SEARCH_PRODUCTO)
                        <div class="input-group mb-3 ">
                            @Html.TextBoxFor(model => model.SEARCH_PRODUCTO, new { @class = "form-control", @maxlength = "200", @aucomplete = "off", @placeholder = "Ingrese descripción o código de producto..." })
                            <div class="input-group-append  btn-hover-shine waves-effect waves-light">
                                <span class="input-group-text"><i class="bi bi-search" style="color: #404040;"></i></span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="form-row" id="_DetallePorductos" style="display: none;">
                    <div class="form-group col-md-6">
                        @Html.LabelFor(model => model.COD_PRODUCTO)
                        @Html.TextBoxFor(model => model.COD_PRODUCTO, new { @class = "form-control", @maxlength = "200", @aucomplete = "off", @disabled = "true" })
                        @Html.ValidationMessageFor(model => model.COD_PRODUCTO, string.Empty, new { @class = "cssMessageError animated  fadeInUp" })
                    </div>
                    <div class="form-group col-md-6">
                        @Html.LabelFor(model => model.ID_UNIDAD_MEDIDA)
                        @Html.DropDownListFor(model => model.ID_UNIDAD_MEDIDA, Model.Lista_Unidad_Medida, new { @class = "form-control", @maxlength = "150", @style = "width:100%", @disabled = "true" })
                        @Html.ValidationMessageFor(model => model.ID_UNIDAD_MEDIDA, string.Empty, new { @class = "cssMessageError animated  fadeInUp" })
                    </div>
                    <div class="form-group col-md-4">
                        @Html.LabelFor(model => model.PRECIO_VENTA)
                        <div class="input-group ">
                            <div class="input-group-prepend">
                                <span class="input-group-text"><span class="simboloMoneda"></span></span>
                            </div>
                            @Html.TextBoxFor(model => model.PRECIO_VENTA, new { @class = "form-control", @maxlength = "100", @aucomplete = "off", @disabled = "true" })
                        </div>
                        @Html.ValidationMessageFor(model => model.PRECIO_VENTA, string.Empty, new { @class = "cssMessageError animated  fadeInUp" })
                    </div>

                    <div class="form-group col-md-4">
                        @Html.LabelFor(model => model.CANTIDAD) <span class="text-success">(stock:<span id="INPUT_STOCK"></span>)</span>
                        <div class="input-group  ">
                            @Html.TextBoxFor(model => model.CANTIDAD, new { @class = "form-control", @maxlength = "10", @autocomplete = "off" })
                            <div class="input-group-append  btn-hover-shine waves-effect waves-light">
                                <span class="input-group-text"><i class="bi bi-files" style="color: #404040;"></i></span>
                            </div>
                        </div>
                        @Html.ValidationMessageFor(model => model.CANTIDAD, string.Empty, new { @class = "cssMessageError animated  fadeInUp" })
                    </div>

                    <div class="form-group col-md-4">
                        @Html.LabelFor(model => model.TOTAL)
                        <div class="input-group ">
                            <div class="input-group-prepend">
                                <span class="input-group-text"><span class="simboloMoneda"></span></span>
                            </div>
                            @Html.TextBoxFor(model => model.TOTAL, new { @class = "form-control", @maxlength = "100", @aucomplete = "off", @disabled = "true" })
                        </div>
                        @Html.ValidationMessageFor(model => model.TOTAL, string.Empty, new { @class = "cssMessageError animated  fadeInUp" })
                    </div>


                    <div class="form-group col-md-12">
                        @Html.LabelFor(model => model.DETALLE)
                        @Html.TextAreaFor(model => model.DETALLE, new { @class = "form-control", @maxlength = "1000", @aucomplete = "off", @disabled = "true" })
                        @Html.ValidationMessageFor(model => model.DETALLE, string.Empty, new { @class = "cssMessageError animated  fadeInUp" })
                    </div>
                </div>

                <div id="Alert_Error" class="alert alert-danger alert-dismissible alert-alt fade show col-md-12" style="display: none;">
                    <strong><i class="bi bi-exclamation-circle"></i>&nbsp;</strong><span id="mensaje_Error"></span>
                </div>

                <div id="Alert_Warning " class="alert alert-warning alert-dismissible alert-alt fade show col-md-12" style="display: none;">
                    <strong><i class="bi bi-exclamation-triangle"></i>&nbsp;</strong><span id="mensaje_Alerta"></span>
                </div>
                
@*     <div class="" style="width: 417px">
                        <div class='_cListProductos   border-bottom-head'>
                            <div class='_text_producto'>item.DESC_PRODUCTO </div>
                            <div class='_InfoProd'>
                                <div class='_Stock'><span><i class='bi bi-box-seam'></i>&nbsp;stock: </span> 20.43 </div>
                                <div class='_Precio'><span><i class='bi bi-cash-stack'></i>&nbsp;precio: </span> 12.25 </div>
                                <div class='_Tipo'><span><i class='bi bi-collection'></i>&nbsp;tipo: </span> servicio  </div>
                                <div class='_FotoPro'>  </div>
                            </div>
                        </div>
                    </div>*@        
            }
        </div>
        <div class="modal-footer">
            <button type="button" id="Sucursal_Btn_Guardar" class="btn btn-hover-shine btn-square btn-primary"><i class="bi bi-basket"></i>&nbsp; Agregar Producto</button>
            <button type="button" class="btn  btn-square btn-dark" id="Btn_CerrarModal">Cancelar</button>
        </div>
    </div>
</div>
@Html.Hidden("hfd_ID_PRODUCTO", Model.ID_PRODUCTO)
@Html.Hidden("hfd_STOCK", Model.STOCK)
@Html.Hidden("hdf_Grilla", Model.GrillaCarga)

