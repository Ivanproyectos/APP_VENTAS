@model App_Ventas.Areas.Ventas.Models.BuscarProductoModelView
<script>
    var _Valido = false;
    var _TOTAL = 0;
    var _ID_SUCURSAL = @Model.ID_SUCURSAL

    $(document).ready(function () {
        ConfiguracionEmpresa();
        $('#CANTIDAD').numeric();
        setTimeout(function () { $('#SEARCH_PRODUCTO').focus(); }, 500); 
    });

    $('#Producto_Btn_Salida').click(function () {
        Producto_Movimiento_Insertar(2);
    });

    $(function () {
        $(".modal-content").draggable();
    });

    $('#CANTIDAD').keyup(function () {
        var _ID_UNIDAD_MEDIDA = $('#ID_UNIDAD_MEDIDA').val();
        var _CANTIDAD = parseInt($(this).val());
        var _CodUnidadMedida = $('#HDF_COD_UNIDAD_MEDIDA').val();
        var _Stock = $('#STOCK').val();
        if (!isNaN(_CANTIDAD) && _CANTIDAD != 0) {
            if (_CANTIDAD < _Stock) {
                _TOTAL = Producto_MovientoProducto_Total(2); // salidas
                var Textinfo = "Se desminuira <b>" + _CANTIDAD + " " + _CodUnidadMedida +
                                 "</b>. del stock actual, haciendo un nuevo total de: <b>" + _TOTAL + " " + _CodUnidadMedida + "</b>";
                $('#Text_InfoStock').html(Textinfo);
                $('#Alert_Info').show('slow');
                _Valido = true;
            } else {
                $('#Alert_Info').hide();
                _Valido = false;
                jError('La cantidad a disminuir no puede ser mayor al stock.', 'Ateción');
            }
        } else {
            $('#Alert_Info').hide();
            _Valido = false;
        }
    });

    function LimpiarFormulario() {
        $('#Alert_Error').hide();
        $('#Alert_Warning').hide();
        $('#mensaje_Error').text('');
        $('#hfd_ID_PRODUCTO').val('');
        $('#hfd_STOCK').val('');
        $('#Alert_Info').hide();
        _Valido = false;
        _Accion = "N";
        _Flg_servicio = false;
    }

    $('#SEARCH_PRODUCTO').keypress(function (event) {
        var keycode = (event.keyCode ? event.keyCode : event.which);
        if (keycode == '13') {
            if (!_Valido) {
                Producto_BuscarProducto($('#SEARCH_PRODUCTO').val(), _ID_SUCURSAL);
            }
        }
    });

    $('#CANTIDAD').keypress(function (event) {
        var keycode = (event.keyCode ? event.keyCode : event.which);
        if (keycode == '13') {
            if (_Valido) {
                //Ventas_Detalle_Insertar();
            }
        }
    });

    /*autocomplete*/
    $('#SEARCH_PRODUCTO').autocomplete(
    {
        source: function (request, response) {
            $.getJSON('@Url.Action("Producto_Buscar_Listar", "Ventas", new { area = "Ventas" })', { DESC_PRODUCTO: request.term.toUpperCase().trim(), ID_SUCURSAL: _ID_SUCURSAL },
        response);
        },
        minLength: 4,
        select: function (event, ui) {
            LimpiarFormulario();
            if (ui.item.FLG_SERVICIO == 0) { // productos          
                $('#_DetallePorductos').show('slow');
                var _STOCK = ui.item.STOCK;
                var _Cantidad = 1;
                $("#Hdf_flg_Servicio").val(ui.item.FLG_SERVICIO);
                $("#SEARCH_PRODUCTO").val(ui.item.DESC_PRODUCTO);
                $("#ID_UNIDAD_MEDIDA").val(ui.item.ID_UNIDAD_MEDIDA);
                $("#HDF_COD_UNIDAD_MEDIDA").val(ui.item.COD_UNIDAD_MEDIDA);
                $("#_Info_codigoUnidad").text(ui.item.COD_UNIDAD_MEDIDA);
                $("#COD_PRODUCTO").val(ui.item.COD_PRODUCTO);
                if (ui.item.ID_UNIDAD_MEDIDA == 1) {
                    _STOCK = ConvertGramos_Kilos(_STOCK);
                }
                $("#hfd_STOCK").val(_STOCK);
                $("#STOCK").val(_STOCK);
                $("#PRECIO_COMPRA").val(Number(ui.item.PRECIO_COMPRA).toFixed(2));
                $('#hfd_ID_PRODUCTO').val(ui.item.ID_PRODUCTO);
                $('#CANTIDAD').val(0);
                $('#CANTIDAD').focus();
                _Valido = true;
            } else if (ui.item.FLG_SERVICIO == 1) { // servicios
                $('#_DetallePorductos').hide();
                $('#mensaje_Alerta').text('Servicios no es apto para este proceso.');
                $('#Alert_Warning').show('slow');
                _Valido = false;
            }
            return false;
        },
        response: function (event, ui) {
            $("#SEARCH_PRODUCTO").val('');
            return false;
        }
    })
    .data("autocomplete")._renderItem = function (ul, item) {
        var _html_FotoProducto = "";
        var _Tipodesc = item.FLG_SERVICIO == 1 ? 'servicio' : 'producto';
        if (item.FLG_SERVICIO == 0 && item.MiArchivo.CODIGO_ARCHIVO != "0") {
            _html_FotoProducto = "<div class='_FotoPro' style=\" background-image: url(@Url.Content("~/Recursos/ImagenProducto/")" + item.MiArchivo.CODIGO_ARCHIVO + item.MiArchivo.EXTENSION + ") \">  </div>";
        }
        var _Stock = item.STOCK;
        if (item.ID_UNIDAD_MEDIDA == 1) {
            _Stock = ConvertGramos_Kilos(_Stock);
        }
        return $("<li id='autocom'></li>")
        .data("item.autocomplete", item)
        .append($("<a></a>").html("<div class='_cListProductos   border-bottom-head'>"
            + "<div class='_text_producto'>" + item.DESC_PRODUCTO + "</div>"
            + "<div class='_InfoProd'> "
            + "<div class='_Stock'> <span> <i class='bi bi-box-seam'></i> stock: </span>" + _Stock + "</div>"
            + "<div class='_Precio'> <span> <i class='bi bi-cash-stack'></i> precio: </span>" + Number(item.PRECIO_VENTA).toFixed(2) + "</div>"
            + "<div class='_Tipo'> <span> <i class='bi bi-back'></i> tipo: </span>" + _Tipodesc + "</div>"
            + _html_FotoProducto
            + " </div></div>"
            )).appendTo(ul);
    }

</script>
<style>
    #modal-dialog_this {
        margin: 30px auto;
    }

    #ModalMovimiento {
        padding: 8px;
        background: #d54e69 !important;
    }
</style>

<div class="modal-dialog" role="document" id="modal-dialog_this">
    <div class="modal-content">
        <div class="modal-header" id="ModalMovimiento">
            <h5 class="modal-title"><i class="bi bi-dash-circle"></i>&nbsp; Salida de stock</h5>
        </div>
        <div class="modal-body">
            @using (Html.BeginForm("", "", new { @area = "" }, FormMethod.Post, new { @id = "frmMantenimiento_BuscarProducto" }))
            {
                @Html.ValidationSummary(true)
                <div class="form-row">
                    <div class="col-sm-12">
                        <h5><i class="bi bi-info-circle text-info "></i>&nbsp;<span class="text-info">Sucursal: @Model.DESC_SUCURSAL </span></h5>
                    </div>
                    <div class="form-group col-md-12 border-bottom-head">
                        <p style="font-weight: bold; color: black;"><i class="bi bi-cart-plus"></i>&nbsp; Busca productos y selecciona. </p>
                        <div class="input-group mb-3 ">
                            @Html.TextBoxFor(model => model.SEARCH_PRODUCTO, new { @class = "form-control", @maxlength = "200", @aucomplete = "off", @placeholder = "Ingrese descripción o código de producto..." })
                            <div class="input-group-append  btn-hover-shine waves-effect waves-light ">
                                <span class="input-group-text input-group-text_white"><i class="bi bi-search" style="color: #404040;"></i></span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="form-row" id="_DetallePorductos" style="display: none;">
                    <div class="form-group col-md-6">
                        @Html.LabelFor(model => model.COD_PRODUCTO)
                        @Html.TextBoxFor(model => model.COD_PRODUCTO, new { @class = "form-control", @maxlength = "200", @aucomplete = "off", @disabled = "true" })
                        @Html.ValidationMessageFor(model => model.COD_PRODUCTO, string.Empty, new { @class = "cssMessageError animated  fadeInUp" })
                    </div>
                    <div class="form-group col-md-6">
                        @Html.LabelFor(model => model.ID_UNIDAD_MEDIDA)
                        @Html.DropDownListFor(model => model.ID_UNIDAD_MEDIDA, Model.Lista_Unidad_Medida, new { @class = "form-control", @maxlength = "150", @style = "width:100%", @disabled = "true" })
                        @Html.ValidationMessageFor(model => model.ID_UNIDAD_MEDIDA, string.Empty, new { @class = "cssMessageError animated  fadeInUp" })
                    </div>
                    <div class="form-group col-md-6">
                        @Html.LabelFor(model => model.STOCK)
                        <div class="input-group ">
                            <div class="input-group-prepend">
                                <span class="input-group-text input-group-text_white"><i class="bi bi-files"></i></span>
                            </div>
                            @Html.TextBoxFor(model => model.STOCK, new { @class = "form-control", @maxlength = "100", @aucomplete = "off", @disabled = "true" })
                        </div>
                        @Html.ValidationMessageFor(model => model.STOCK, string.Empty, new { @class = "cssMessageError animated  fadeInUp" })
                    </div>

                    <div class="form-group col-md-6">
                        @Html.LabelFor(model => model.CANTIDAD)
                        <div class="input-group  ">
                            @Html.TextBoxFor(model => model.CANTIDAD, new { @class = "form-control", @maxlength = "10", @autocomplete = "off" })
                            <div class="input-group-append  btn-hover-shine waves-effect waves-light">
                                <span class="input-group-text input-group-text_white" id="_Info_codigoUnidad">
                                    @if (Model.COD_UNIDAD_MEDIDA != null)
                                    {
                                        @Model.COD_UNIDAD_MEDIDA;
                                    }
                                    else
                                    {
                                        <i class="bi bi-files" style="color: #404040;"></i>
                                    }
                                </span>
                            </div>
                        </div>
                        @Html.ValidationMessageFor(model => model.CANTIDAD, string.Empty, new { @class = "cssMessageError animated  fadeInUp" })
                    </div>
                    <div class="form-group col-md-12">
                        <label>Observación</label>
                        @Html.TextAreaFor(model => model.DETALLE, new { @class = "form-control", @maxlength = "1000", @aucomplete = "off", @placeholder = "Ingrese una observación." })
                        @Html.ValidationMessageFor(model => model.DETALLE, string.Empty, new { @class = "cssMessageError animated  fadeInUp" })
                    </div>
                </div>

                <div id="Alert_Warning" class="alert alert-warning alert-dismissible alert-alt fade show col-md-12" style="display: none;">
                    <strong><i class="bi bi-exclamation-triangle"></i>&nbsp;</strong><span id="mensaje_Alerta"></span>
                </div>    
                
                <div id="Alert_Info" class="alert alert-info alert-dismissible alert-alt fade show col-md-12" style="display: none;">
                    <button type="button" class="close h-100" data-dismiss="alert" aria-label="Close">
                        <span><i class="bi bi-x-lg"></i></span>
                    </button>
                    <strong><i class="bi bi-files"></i></strong>&nbsp;<span id="Text_InfoStock"></span>.                           
                </div>
                
            }
        </div>
        <div class="modal-footer">
            <button type="button" id="Producto_Btn_Salida" class="btn btn-hover-shine btn-square btn-danger"><i class="bi bi-dash-circle"></i>&nbsp; Disminuir stock</button>
            <button type="button" class="btn  btn-square btn-dark" data-dismiss="modal">Cancelar</button>
        </div>
    </div>
</div>
@Html.Hidden("hfd_ID_PRODUCTO", Model.ID_PRODUCTO)
@Html.Hidden("hfd_STOCK", Model.STOCK)
@Html.Hidden("Hdf_flg_Servicio", Model.FLG_SERVICIO)
@Html.Hidden("AccionBuscarProducto", Model.Accion)
@Html.Hidden("HDF_COD_UNIDAD_MEDIDA", Model.COD_UNIDAD_MEDIDA)
